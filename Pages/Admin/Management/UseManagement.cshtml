@page
@using PlantManagement.Pages.Shared
@model UseManagementModel
@{
  Layout = "_AdminLayout";
  ViewData["Title"] = "Quản lý công dụng";
}

@section Styles {
  <link rel="stylesheet" href="~/css/admin/category-management.css" />
  <link rel="stylesheet" href="~/css/shared/pagination.css" />
}

<div class="search-section">
  <form method="get" class="search-form">
    <input type="text" name="Keyword" value="@Model.Keyword" placeholder="Tìm kiếm tên công dụng" class="search-input" />
    <button type="submit" class="btn-search">Tìm kiếm</button>
  </form>
  <button class="btn btn-success ms-2" onclick="openAddModal()">Thêm công dụng mới</button>
</div>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>Tên công dụng</th>
      <th>Mô tả</th>
      <th>Hành động</th>
    </tr>
  </thead>
  <tbody>
    @foreach (var use in Model.Uses.Items)
    {
      <tr>
        <td>@use.UseName</td>
        <td id="desc_@use.UseId">@use.Description</td>
        <td>
          <button class="btn btn-primary btn-sm" onclick="openEditModal(@use.UseId)">Xem chi tiết</button>
          <button class="btn btn-danger btn-sm" onclick="checkBeforeDelete(@use.UseId)">
            <i class="bi bi-trash"></i> Xóa
          </button>
        </td>
      </tr>
    }
  </tbody>
</table>

<!-- Modal chỉnh sửa công dụng -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editForm" onsubmit="return saveEditUse();">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Chỉnh sửa công dụng</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editUseId" name="UseId" />
          <div class="mb-3">
            <label for="editUseName" class="form-label">Tên công dụng <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="editUseName" name="UseName" required />
          </div>
          <div class="mb-3">
            <label for="editDescription" class="form-label">Mô tả</label>
            <textarea class="form-control" id="editDescription" name="Description" rows="4"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <span id="editError" class="text-danger me-auto"></span>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          <button type="submit" class="btn btn-success">Lưu</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal thêm công dụng -->
<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="addForm" onsubmit="return saveAddUse();">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Thêm công dụng mới</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="addUseName" class="form-label">Tên công dụng <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="addUseName" name="UseName" required />
          </div>
          <div class="mb-3">
            <label for="addDescription" class="form-label">Mô tả</label>
            <textarea class="form-control" id="addDescription" name="Description" rows="4"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <span id="addError" class="text-danger me-auto"></span>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          <button type="submit" class="btn btn-success">Thêm mới</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal xác nhận xóa -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Xác nhận xóa công dụng</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="deleteModalBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xóa</button>
      </div>
    </div>
  </div>
</div>

@if (Model.TotalPages > 1)
{
  var paginationModel = new PaginationModel
  {
    CurrentPage = Model.CurrentPage,
    TotalPages = Model.TotalPages,
    PageUrl = (page) => Url.Page("/Admin/Management/UseManagement", null, new
    {
      CurrentPage = page,
      Keyword = Model.Keyword,
    }, null) ?? "#"
  };

  <div class="pagination-container">
    @await Html.PartialAsync("Shared/_Pagination", paginationModel)
  </div>
}

@section Scripts {
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let editModal = new bootstrap.Modal(document.getElementById('editModal'));

    function openEditModal(id) {
      document.getElementById('editError').innerText = '';
      fetch(`/Admin/Management/UseManagement?handler=Detail&id=${id}`)
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            document.getElementById('editUseId').value = data.use.useId;
            document.getElementById('editUseName').value = data.use.useName;
            document.getElementById('editDescription').value = data.use.description || '';
            editModal.show();
          } else {
            alert("Không tìm thấy công dụng.");
          }
        });
    }

    function saveEditUse() {
      const formData = new FormData();
      formData.append("UseId", document.getElementById("editUseId").value);
      formData.append("UseName", document.getElementById("editUseName").value);
      formData.append("Description", document.getElementById("editDescription").value);

      fetch(`/Admin/Management/UseManagement?handler=Edit`, {
        method: 'POST',
        body: formData
      })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            showToast(data.message, "success");
            document.getElementById(`desc_${formData.get("UseId")}`).innerText = formData.get("Description");
            editModal.hide();
            reloadUseList();
          } else {
            document.getElementById('editError').innerText = data.message || "Có lỗi xảy ra!";
          }
        });

      return false;
    }

    let addModal = new bootstrap.Modal(document.getElementById('addModal'));

    function openAddModal() {
      document.getElementById('addError').innerText = '';
      document.getElementById('addUseName').value = '';
      document.getElementById('addDescription').value = '';
      addModal.show();
    }

    function saveAddUse() {
      const formData = new FormData();
      formData.append("UseName", document.getElementById("addUseName").value);
      formData.append("Description", document.getElementById("addDescription").value);

      fetch(`/Admin/Management/UseManagement?handler=Add`, {
        method: 'POST',
        body: formData
      })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            showToast(data.message, "success");
            addModal.hide();
            reloadUseList();
          } else {
            document.getElementById('addError').innerText = data.message || "Có lỗi xảy ra!";
          }
        })
        .catch(err => console.error("Error adding use:", err));

      return false;
    }

    let deleteUseId = 0;

    function checkBeforeDelete(id) {
      fetch(`/Admin/Management/UseManagement?handler=CheckBeforeDelete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      })
        .then(res => res.json())
        .then(data => {
          deleteUseId = id;
          document.getElementById("deleteModalBody").innerHTML = data.message;
          new bootstrap.Modal(document.getElementById("deleteConfirmModal")).show();
        });
    }

    document.getElementById("confirmDeleteBtn").addEventListener("click", () => {
      fetch(`/Admin/Management/UseManagement?handler=DeleteConfirmed&id=${deleteUseId}`, {
        method: 'POST'
      })
        .then(res => res.json())
        .then(data => {
          showToast(data.message, data.success ? "success" : "warning");
          if (data.success) {
            if (@Model.CurrentPage > data.totalPages) {
              reloadUseList(data.totalPages);
            } else {
              reloadUseList();
            }
          }
          bootstrap.Modal.getInstance(document.getElementById("deleteConfirmModal")).hide();
        });
    });

    function reloadUseList(newPage) {
      const pageToLoad = newPage || @Model.CurrentPage;
      const url = `/Admin/Management/UseManagement?handler=List&keyword=${encodeURIComponent("@Model.Keyword")}&currentPage=${pageToLoad}`;

      fetch(url)
        .then(res => res.text())
        .then(html => {
          document.querySelector("table tbody").innerHTML = html;

          fetch(window.location.pathname + `?Keyword=${encodeURIComponent("@Model.Keyword")}&CurrentPage=${pageToLoad}`)
            .then(r => r.text())
            .then(pageHtml => {
              const parser = new DOMParser();
              const newDoc = parser.parseFromString(pageHtml, 'text/html');
              const newPagination = newDoc.querySelector('.pagination-container');

              if (newPagination) {
                document.querySelector('.pagination-container').innerHTML = newPagination.innerHTML;
              }
            });
        })
        .catch(err => console.error("Error reloading uses:", err));
    }
  </script>
}