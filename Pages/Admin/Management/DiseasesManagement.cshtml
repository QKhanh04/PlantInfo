@page
@using PlantManagement.Pages.Shared
@model DiseasesManagementModel
@{
  Layout = "_AdminLayout";
  ViewData["Title"] = "Quản lý sâu bệnh";
}

@section Styles {
  <link rel="stylesheet" href="~/css/admin/category-management.css" />
  <link rel="stylesheet" href="~/css/shared/pagination.css" />
}

<div class="search-section">
  <form method="get" class="search-form">
    <input type="text" name="Keyword" value="@Model.Keyword" placeholder="Tìm kiếm tên bệnh, triệu chứng, cây" class="search-input" />
    
    <select name="PlantId" class="form-select" style="width: 200px; margin-left: 10px;">
      <option value="">-- Tất cả cây --</option>
      @foreach (var plant in Model.Plants)
      {
        <option value="@plant.PlantId" selected="@(Model.PlantId == plant.PlantId)">
          @(plant.CommonName ?? "Không rõ")
        </option>
      }
    </select>
    
    <button type="submit" class="btn-search">Tìm kiếm</button>
  </form>
  <button class="btn btn-success ms-2" onclick="openAddModal()">Thêm sâu bệnh mới</button>
</div>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>Tên bệnh</th>
      <th>Cây trồng</th>
      <th>Triệu chứng</th>
      <th>Hành động</th>
    </tr>
  </thead>
  <tbody>
    @foreach (var disease in Model.Diseases.Items)
    {
      <tr>
        <td>@disease.DiseaseName</td>
        <td>@(disease.PlantName ?? "Không rõ")</td>
        <td>@(disease.Symptoms != null && disease.Symptoms.Length > 100 ? disease.Symptoms.Substring(0, 100) + "..." : disease.Symptoms)</td>
        <td>
          <button class="btn btn-primary btn-sm" onclick="openEditModal(@disease.DiseaseId)">Xem chi tiết</button>
          <button class="btn btn-danger btn-sm" onclick="deleteDisease(@disease.DiseaseId)">
            <i class="bi bi-trash"></i> Xóa
          </button>
        </td>
      </tr>
    }
  </tbody>
</table>

<!-- Modal chỉnh sửa sâu bệnh -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="editForm" onsubmit="return saveEditDisease();">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Chỉnh sửa thông tin sâu bệnh</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editDiseaseId" name="DiseaseId" />
          <div class="mb-3">
            <label for="editPlantId" class="form-label">Cây trồng <span class="text-danger">*</span></label>
            <select class="form-select" id="editPlantId" name="PlantId" required>
              <option value="">-- Chọn cây --</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="editDiseaseName" class="form-label">Tên bệnh <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="editDiseaseName" name="DiseaseName" required />
          </div>
          <div class="mb-3">
            <label for="editSymptoms" class="form-label">Triệu chứng</label>
            <textarea class="form-control" id="editSymptoms" name="Symptoms" rows="4"></textarea>
          </div>
          <div class="mb-3">
            <label for="editTreatment" class="form-label">Cách điều trị</label>
            <textarea class="form-control" id="editTreatment" name="Treatment" rows="4"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <span id="editError" class="text-danger me-auto"></span>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          <button type="submit" class="btn btn-success">Lưu</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal thêm sâu bệnh -->
<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="addForm" onsubmit="return saveAddDisease();">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Thêm sâu bệnh mới</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="addPlantId" class="form-label">Cây trồng <span class="text-danger">*</span></label>
            <select class="form-select" id="addPlantId" name="PlantId" required>
              <option value="">-- Chọn cây --</option>
            </select>
          </div>
          <div class="mb-3">
            <label for="addDiseaseName" class="form-label">Tên bệnh <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="addDiseaseName" name="DiseaseName" required />
          </div>
          <div class="mb-3">
            <label for="addSymptoms" class="form-label">Triệu chứng</label>
            <textarea class="form-control" id="addSymptoms" name="Symptoms" rows="4"></textarea>
          </div>
          <div class="mb-3">
            <label for="addTreatment" class="form-label">Cách điều trị</label>
            <textarea class="form-control" id="addTreatment" name="Treatment" rows="4"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <span id="addError" class="text-danger me-auto"></span>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          <button type="submit" class="btn btn-success">Thêm mới</button>
        </div>
      </div>
    </form>
  </div>
</div>

@if (Model.TotalPages > 1)
{
  var paginationModel = new PaginationModel
  {
    CurrentPage = Model.CurrentPage,
    TotalPages = Model.TotalPages,
    PageUrl = (page) => Url.Page("/Admin/Management/DiseasesManagement", null, new
    {
      CurrentPage = page,
      Keyword = Model.Keyword,
      PlantId = Model.PlantId
    }, null) ?? "#"
  };

  <div class="pagination-container">
    @await Html.PartialAsync("Shared/_Pagination", paginationModel)
  </div>
}

@section Scripts {
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let editModal = new bootstrap.Modal(document.getElementById('editModal'));
    let addModal = new bootstrap.Modal(document.getElementById('addModal'));
    let plantsData = [];

    // Load danh sách plants khi trang load
    async function loadPlants() {
      try {
        const response = await fetch('/Admin/Management/DiseasesManagement?handler=Plants');
        const data = await response.json();
        if (data.success) {
          plantsData = data.plants;
          populatePlantDropdown('editPlantId', plantsData);
          populatePlantDropdown('addPlantId', plantsData);
        }
      } catch (err) {
        console.error('Error loading plants:', err);
      }
    }

    function populatePlantDropdown(selectId, plants) {
      const select = document.getElementById(selectId);
      const currentValue = select.value;
      select.innerHTML = '<option value="">-- Chọn cây --</option>';
      
      plants.forEach(plant => {
        const option = document.createElement('option');
        option.value = plant.plantId;
        option.textContent = plant.commonName || plant.scientificName || 'Không rõ';
        select.appendChild(option);
      });
      
      if (currentValue) {
        select.value = currentValue;
      }
    }

    function openEditModal(id) {
      document.getElementById('editError').innerText = '';
      fetch(`/Admin/Management/DiseasesManagement?handler=Detail&id=${id}`)
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            document.getElementById('editDiseaseId').value = data.disease.diseaseId;
            document.getElementById('editPlantId').value = data.disease.plantId;
            document.getElementById('editDiseaseName').value = data.disease.diseaseName;
            document.getElementById('editSymptoms').value = data.disease.symptoms || '';
            document.getElementById('editTreatment').value = data.disease.treatment || '';
            editModal.show();
          } else {
            alert("Không tìm thấy sâu bệnh.");
          }
        });
    }

    function saveEditDisease() {
      const formData = new FormData();
      formData.append("DiseaseId", document.getElementById("editDiseaseId").value);
      formData.append("PlantId", document.getElementById("editPlantId").value);
      formData.append("DiseaseName", document.getElementById("editDiseaseName").value);
      formData.append("Symptoms", document.getElementById("editSymptoms").value);
      formData.append("Treatment", document.getElementById("editTreatment").value);

      fetch(`/Admin/Management/DiseasesManagement?handler=Edit`, {
        method: 'POST',
        body: formData
      })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            showToast(data.message, "success");
            editModal.hide();
            reloadDiseaseList();
          } else {
            document.getElementById('editError').innerText = data.message || "Có lỗi xảy ra!";
          }
        });

      return false;
    }

    function openAddModal() {
      document.getElementById('addError').innerText = '';
      document.getElementById('addPlantId').value = '';
      document.getElementById('addDiseaseName').value = '';
      document.getElementById('addSymptoms').value = '';
      document.getElementById('addTreatment').value = '';
      addModal.show();
    }

    function saveAddDisease() {
      const formData = new FormData();
      formData.append("PlantId", document.getElementById("addPlantId").value);
      formData.append("DiseaseName", document.getElementById("addDiseaseName").value);
      formData.append("Symptoms", document.getElementById("addSymptoms").value);
      formData.append("Treatment", document.getElementById("addTreatment").value);

      fetch(`/Admin/Management/DiseasesManagement?handler=Add`, {
        method: 'POST',
        body: formData
      })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            showToast(data.message, "success");
            addModal.hide();
            reloadDiseaseList();
          } else {
            document.getElementById('addError').innerText = data.message || "Có lỗi xảy ra!";
          }
        })
        .catch(err => console.error("Error adding disease:", err));

      return false;
    }

    function deleteDisease(id) {
      if (!confirm('Bạn có chắc chắn muốn xóa sâu bệnh này?')) {
        return;
      }

      fetch(`/Admin/Management/DiseasesManagement?handler=Delete&id=${id}`, {
        method: 'POST'
      })
        .then(res => res.json())
        .then(data => {
          showToast(data.message, data.success ? "success" : "warning");
          if (data.success) {
            if (@Model.CurrentPage > data.totalPages) {
              reloadDiseaseList(data.totalPages);
            } else {
              reloadDiseaseList();
            }
          }
        });
    }

    function reloadDiseaseList(newPage) {
      const pageToLoad = newPage || @Model.CurrentPage;
      const plantId = @(Model.PlantId.HasValue ? Model.PlantId.Value.ToString() : "null");
      const url = `/Admin/Management/DiseasesManagement?handler=List&keyword=${encodeURIComponent("@Model.Keyword")}&plantId=${plantId}&currentPage=${pageToLoad}`;

      fetch(url)
        .then(res => res.text())
        .then(html => {
          document.querySelector("table tbody").innerHTML = html;

          const fetchUrl = window.location.pathname + `?Keyword=${encodeURIComponent("@Model.Keyword")}&PlantId=${plantId}&CurrentPage=${pageToLoad}`;
          fetch(fetchUrl)
            .then(r => r.text())
            .then(pageHtml => {
              const parser = new DOMParser();
              const newDoc = parser.parseFromString(pageHtml, 'text/html');
              const newPagination = newDoc.querySelector('.pagination-container');

              if (newPagination) {
                document.querySelector('.pagination-container').innerHTML = newPagination.innerHTML;
              }
            });
        })
        .catch(err => console.error("Error reloading diseases:", err));
    }

    // Load plants khi trang load
    document.addEventListener('DOMContentLoaded', function() {
      loadPlants();
    });
  </script>
}