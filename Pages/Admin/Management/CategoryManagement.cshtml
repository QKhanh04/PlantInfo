@page
@using PlantManagement.Pages.Shared
@model CategoryManagementModel
@{
  Layout = "_AdminLayout";
  ViewData["Title"] = "Quản lý danh mục";
}

@section Styles {
  <link rel="stylesheet" href="~/css/admin/category-management.css" />
  <link rel="stylesheet" href="~/css/shared/pagination.css" />
}

<div class="search-section">
    <form method="get" class="search-form">
        <input type="text" 
               name="Keyword" 
               value="@Model.Keyword" 
               placeholder="Tìm kiếm tên danh mục"
               class="search-input" />


        <button type="submit" class="btn-search">Tìm kiếm</button>
    </form>
</div>
<table class="table table-bordered">
  <thead>
    <tr>
      <th>Tên danh mục</th>
      <th>Mô tả</th>
      <th>Hành động</th>
    </tr>
  </thead>
  <tbody>
    @foreach (var cat in Model.Categories.Items)
    {
      <tr>
        <td>@cat.CategoryName</td>
        <td id="desc_@cat.CategoryId">@cat.Description</td>
        <td>
          <button class="btn btn-primary btn-sm" onclick="openEditModal(@cat.CategoryId)">Xem chi tiết</button>
        </td>
      </tr>
    }
  </tbody>
</table>

<!-- Modal chỉnh sửa danh mục -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <form id="editForm" onsubmit="return saveEditCategory();">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Sửa mô tả danh mục</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editCategoryId" name="CategoryId" />
          <div class="mb-3">
            <label for="editCategoryName" class="form-label">Tên danh mục</label>
            <input type="text" class="form-control" id="editCategoryName" name="CategoryName" readonly />
          </div>
          <div class="mb-3">
            <label for="editDescription" class="form-label">Mô tả</label>
            <textarea class="form-control" id="editDescription" name="Description"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <span id="editError" class="text-danger me-auto"></span>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          <button type="submit" class="btn btn-success">Lưu</button>
        </div>
      </div>
    </form>
  </div>
</div>
@if (Model.TotalPages > 1)
{
    var paginationModel = new PaginationModel
    {
        CurrentPage = Model.CurrentPage,
        TotalPages = Model.TotalPages,
        PageUrl = (page) => Url.Page("/Admin/Management/CategoryManagement", null, new
        {
            CurrentPage = page,
            Keyword = Model.Keyword,
        }, null) ?? "#"
    };

    <div class="pagination-container">
        @await Html.PartialAsync("Shared/_Pagination", paginationModel)
    </div>
}

@section Scripts {
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let editModal = new bootstrap.Modal(document.getElementById('editModal'));

    function openEditModal(id) {
      // Reset lỗi
      document.getElementById('editError').innerText = '';
      // Gọi AJAX để lấy thông tin chi tiết
      fetch(`/Admin/Management/CategoryManagement?handler=Detail&id=${id}`)
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            document.getElementById('editCategoryId').value = data.category.categoryId;
            document.getElementById('editCategoryName').value = data.category.categoryName;
            document.getElementById('editDescription').value = data.category.description;
            editModal.show();
          } else {
            alert("Không tìm thấy danh mục.");
          }
        });
    }

    function saveEditCategory() {
      const formData = new FormData();
      formData.append("CategoryId", document.getElementById("editCategoryId").value);
      formData.append("Description", document.getElementById("editDescription").value);

      fetch(`/Admin/Management/CategoryManagement?handler=Edit`, {
        method: 'POST',
        body: formData
      })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            document.getElementById(`desc_${formData.get("CategoryId")}`).innerText = formData.get("Description");
            editModal.hide();
          } else {
            document.getElementById('editError').innerText = data.message || "Có lỗi xảy ra!";
          }
        });

      return false;
    }

  </script>
}