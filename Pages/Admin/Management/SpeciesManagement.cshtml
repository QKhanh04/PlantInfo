@page
@using PlantManagement.Pages.Shared
@model SpeciesManagementModel
@{
    Layout = "_AdminLayout";
    ViewData["Title"] = "Quản lý loài";
}

@section Styles {
    <link rel="stylesheet" href="~/css/admin/category-management.css" />
    <link rel="stylesheet" href="~/css/shared/pagination.css" />
}

<div class="search-section mb-2">
    <form method="get" class="search-form">
        <input type="text" name="Keyword" value="@Model.Keyword" placeholder="Tìm kiếm tên khoa học"
            class="search-input" />
        <button type="submit" class="btn-search">Tìm kiếm</button>
    </form>
    <button class="btn btn-success ms-2" onclick="openAddModal()">Thêm loài mới</button>
</div>
<table class="table table-bordered">
    <thead>
        <tr>
            <th>Tên khoa học</th>
            <th>Chi</th>
            <th>Họ</th>
            <th>Bộ</th>
            <th>Mô tả</th>
            <th>Hành động</th>
        </tr>
    </thead>
    <tbody>
        @foreach (var sp in Model.SpeciesList.Items)
        {
            <tr>
                <td>@sp.ScientificName</td>
                <td>@sp.Genus</td>
                <td>@sp.Family</td>
                <td>@sp.OrderName</td>
                <td id="desc_@sp.SpeciesId">@sp.Description</td>
                <td>
                    <button class="btn btn-primary btn-sm" onclick="openEditModal(@sp.SpeciesId)">Xem/sửa</button>
                </td>
            </tr>
        }
    </tbody>
</table>

<!-- Modal sửa -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="editForm" onsubmit="return saveEditSpecies();">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Sửa loài</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body">
                    <input type="hidden" id="editSpeciesId" name="SpeciesId" />
                    <div class="mb-3">
                        <label for="editScientificName" class="form-label">Tên khoa học</label>
                        <input type="text" class="form-control" id="editScientificName" name="ScientificName" readonly />
                    </div>
                    <div class="mb-3">
                        <label for="editGenus" class="form-label">Chi</label>
                        <input type="text" class="form-control" id="editGenus" name="Genus" />
                    </div>
                    <div class="mb-3">
                        <label for="editFamily" class="form-label">Họ</label>
                        <input type="text" class="form-control" id="editFamily" name="Family" />
                    </div>
                    <div class="mb-3">
                        <label for="editOrderName" class="form-label">Bộ</label>
                        <input type="text" class="form-control" id="editOrderName" name="OrderName" />
                    </div>
                    <div class="mb-3">
                        <label for="editDescription" class="form-label">Mô tả</label>
                        <textarea class="form-control" id="editDescription" name="Description"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <span id="editError" class="text-danger me-auto"></span>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-success">Lưu</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Modal thêm -->
<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <form id="addForm" onsubmit="return saveAddSpecies();">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Thêm loài mới</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="addScientificName" class="form-label">Tên khoa học</label>
                        <input type="text" class="form-control" id="addScientificName" name="ScientificName" required />
                    </div>
                    <div class="mb-3">
                        <label for="addGenus" class="form-label">Chi</label>
                        <input type="text" class="form-control" id="addGenus" name="Genus" />
                    </div>
                    <div class="mb-3">
                        <label for="addFamily" class="form-label">Họ</label>
                        <input type="text" class="form-control" id="addFamily" name="Family" />
                    </div>
                    <div class="mb-3">
                        <label for="addOrderName" class="form-label">Bộ</label>
                        <input type="text" class="form-control" id="addOrderName" name="OrderName" />
                    </div>
                    <div class="mb-3">
                        <label for="addDescription" class="form-label">Mô tả</label>
                        <textarea class="form-control" id="addDescription" name="Description"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <span id="addError" class="text-danger me-auto"></span>
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
                    <button type="submit" class="btn btn-success">Thêm mới</button>
                </div>
            </div>
        </form>
    </div>
</div>

@if (Model.TotalPages > 1)
{
    var paginationModel = new PaginationModel
    {
        CurrentPage = Model.CurrentPage,
        TotalPages = Model.TotalPages,
        PageUrl = (page) => Url.Page("/Admin/Management/SpeciesManagement", null, new
        {
            CurrentPage = page,
            Keyword = Model.Keyword,
        }, null) ?? "#"
    };

    <div class="pagination-container">
        @await Html.PartialAsync("Shared/_Pagination", paginationModel)
    </div>
}

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        let editModal = new bootstrap.Modal(document.getElementById('editModal'));
        let addModal = new bootstrap.Modal(document.getElementById('addModal'));

        function openEditModal(id) {
            document.getElementById('editError').innerText = '';
            fetch(`/Admin/Management/SpeciesManagement?handler=Detail&id=${id}`)
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('editSpeciesId').value = data.species.speciesId;
                        document.getElementById('editScientificName').value = data.species.scientificName;
                        document.getElementById('editGenus').value = data.species.genus;
                        document.getElementById('editFamily').value = data.species.family;
                        document.getElementById('editOrderName').value = data.species.orderName;
                        document.getElementById('editDescription').value = data.species.description;
                        editModal.show();
                    } else {
                        alert(data.message || "Không tìm thấy loài.");
                    }
                });
        }

        function saveEditSpecies() {
            const formData = new FormData();
            formData.append("SpeciesId", document.getElementById("editSpeciesId").value);
            formData.append("Genus", document.getElementById("editGenus").value);
            formData.append("Family", document.getElementById("editFamily").value);
            formData.append("OrderName", document.getElementById("editOrderName").value);
            formData.append("Description", document.getElementById("editDescription").value);

            fetch(`/Admin/Management/SpeciesManagement?handler=Edit`, {
                method: 'POST',
                body: formData
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById(`desc_${formData.get("SpeciesId")}`).innerText = formData.get("Description");
                        editModal.hide();
                    } else {
                        document.getElementById('editError').innerText = data.message || "Có lỗi xảy ra!";
                    }
                });

            return false;
        }

        function openAddModal() {
            document.getElementById('addError').innerText = '';
            document.getElementById('addScientificName').value = '';
            document.getElementById('addGenus').value = '';
            document.getElementById('addFamily').value = '';
            document.getElementById('addOrderName').value = '';
            document.getElementById('addDescription').value = '';
            addModal.show();
        }

        function saveAddSpecies() {
            const formData = new FormData();
            formData.append("ScientificName", document.getElementById("addScientificName").value);
            formData.append("Genus", document.getElementById("addGenus").value);
            formData.append("Family", document.getElementById("addFamily").value);
            formData.append("OrderName", document.getElementById("addOrderName").value);
            formData.append("Description", document.getElementById("addDescription").value);

            fetch(`/Admin/Management/SpeciesManagement?handler=Add`, {
                method: 'POST',
                body: formData
            })
                .then(r => r.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        document.getElementById('addError').innerText = data.message || "Có lỗi xảy ra!";
                    }
                });

            return false;
        }
    </script>
}