@page
@using PlantManagement.Pages.Shared
@model SpeciesManagementModel
@{
  Layout = "_AdminLayout";
  ViewData["Title"] = "Quản lý loài";
}

@section Styles {
  <link rel="stylesheet" href="~/css/admin/category-management.css" />
  <link rel="stylesheet" href="~/css/shared/pagination.css" />
}

<div class="search-section">
  <form method="get" class="search-form">
    <input type="text" name="Keyword" value="@Model.Keyword" placeholder="Tìm kiếm tên khoa học, chi, họ" class="search-input" />
    <button type="submit" class="btn-search">Tìm kiếm</button>
  </form>
  <button class="btn btn-success ms-2" onclick="openAddModal()">Thêm loài mới</button>
</div>

<table class="table table-bordered">
  <thead>
    <tr>
      <th>Tên khoa học</th>
      <th>Chi</th>
      <th>Họ</th>
      <th>Bộ</th>
      <th>Hành động</th>
    </tr>
  </thead>
  <tbody>
    @foreach (var sp in Model.Species.Items)
    {
      <tr>
        <td>@sp.ScientificName</td>
        <td>@sp.Genus</td>
        <td>@sp.Family</td>
        <td>@sp.OrderName</td>
        <td>
          <button class="btn btn-primary btn-sm" onclick="openEditModal(@sp.SpeciesId)">Xem chi tiết</button>
          <button class="btn btn-danger btn-sm" onclick="checkBeforeDelete(@sp.SpeciesId)">
            <i class="bi bi-trash"></i> Xóa
          </button>
        </td>
      </tr>
    }
  </tbody>
</table>

<!-- Modal chỉnh sửa loài -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="editForm" onsubmit="return saveEditSpecies();">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Chỉnh sửa thông tin loài</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          <input type="hidden" id="editSpeciesId" name="SpeciesId" />
          <div class="mb-3">
            <label for="editScientificName" class="form-label">Tên khoa học <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="editScientificName" name="ScientificName" required />
          </div>
          <div class="mb-3">
            <label for="editGenus" class="form-label">Chi</label>
            <input type="text" class="form-control" id="editGenus" name="Genus" />
          </div>
          <div class="mb-3">
            <label for="editFamily" class="form-label">Họ</label>
            <input type="text" class="form-control" id="editFamily" name="Family" />
          </div>
          <div class="mb-3">
            <label for="editOrderName" class="form-label">Bộ</label>
            <input type="text" class="form-control" id="editOrderName" name="OrderName" />
          </div>
          <div class="mb-3">
            <label for="editDescription" class="form-label">Mô tả</label>
            <textarea class="form-control" id="editDescription" name="Description" rows="4"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <span id="editError" class="text-danger me-auto"></span>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          <button type="submit" class="btn btn-success">Lưu</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal thêm loài -->
<div class="modal fade" id="addModal" tabindex="-1" aria-labelledby="addModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg">
    <form id="addForm" onsubmit="return saveAddSpecies();">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title">Thêm loài mới</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
        </div>
        <div class="modal-body">
          <div class="mb-3">
            <label for="addScientificName" class="form-label">Tên khoa học <span class="text-danger">*</span></label>
            <input type="text" class="form-control" id="addScientificName" name="ScientificName" required />
          </div>
          <div class="mb-3">
            <label for="addGenus" class="form-label">Chi</label>
            <input type="text" class="form-control" id="addGenus" name="Genus" />
          </div>
          <div class="mb-3">
            <label for="addFamily" class="form-label">Họ</label>
            <input type="text" class="form-control" id="addFamily" name="Family" />
          </div>
          <div class="mb-3">
            <label for="addOrderName" class="form-label">Bộ</label>
            <input type="text" class="form-control" id="addOrderName" name="OrderName" />
          </div>
          <div class="mb-3">
            <label for="addDescription" class="form-label">Mô tả</label>
            <textarea class="form-control" id="addDescription" name="Description" rows="4"></textarea>
          </div>
        </div>
        <div class="modal-footer">
          <span id="addError" class="text-danger me-auto"></span>
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Đóng</button>
          <button type="submit" class="btn btn-success">Thêm mới</button>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Modal xác nhận xóa -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title">Xác nhận xóa loài</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body" id="deleteModalBody"></div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
        <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xóa</button>
      </div>
    </div>
  </div>
</div>

@if (Model.TotalPages > 1)
{
  var paginationModel = new PaginationModel
  {
    CurrentPage = Model.CurrentPage,
    TotalPages = Model.TotalPages,
    PageUrl = (page) => Url.Page("/Admin/Management/SpeciesManagement", null, new
    {
      CurrentPage = page,
      Keyword = Model.Keyword,
    }, null) ?? "#"
  };

  <div class="pagination-container">
    @await Html.PartialAsync("Shared/_Pagination", paginationModel)
  </div>
}

@section Scripts {
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    let editModal = new bootstrap.Modal(document.getElementById('editModal'));

    function openEditModal(id) {
      document.getElementById('editError').innerText = '';
      fetch(`/Admin/Management/SpeciesManagement?handler=Detail&id=${id}`)
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            document.getElementById('editSpeciesId').value = data.species.speciesId;
            document.getElementById('editScientificName').value = data.species.scientificName;
            document.getElementById('editGenus').value = data.species.genus || '';
            document.getElementById('editFamily').value = data.species.family || '';
            document.getElementById('editOrderName').value = data.species.orderName || '';
            document.getElementById('editDescription').value = data.species.description || '';
            editModal.show();
          } else {
            alert("Không tìm thấy loài.");
          }
        });
    }

    function saveEditSpecies() {
      const formData = new FormData();
      formData.append("SpeciesId", document.getElementById("editSpeciesId").value);
      formData.append("ScientificName", document.getElementById("editScientificName").value);
      formData.append("Genus", document.getElementById("editGenus").value);
      formData.append("Family", document.getElementById("editFamily").value);
      formData.append("OrderName", document.getElementById("editOrderName").value);
      formData.append("Description", document.getElementById("editDescription").value);

      fetch(`/Admin/Management/SpeciesManagement?handler=Edit`, {
        method: 'POST',
        body: formData
      })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            showToast(data.message, "success");
            editModal.hide();
            reloadSpeciesList();
          } else {
            document.getElementById('editError').innerText = data.message || "Có lỗi xảy ra!";
          }
        });

      return false;
    }

    let addModal = new bootstrap.Modal(document.getElementById('addModal'));

    function openAddModal() {
      document.getElementById('addError').innerText = '';
      document.getElementById('addScientificName').value = '';
      document.getElementById('addGenus').value = '';
      document.getElementById('addFamily').value = '';
      document.getElementById('addOrderName').value = '';
      document.getElementById('addDescription').value = '';
      addModal.show();
    }

    function saveAddSpecies() {
      const formData = new FormData();
      formData.append("ScientificName", document.getElementById("addScientificName").value);
      formData.append("Genus", document.getElementById("addGenus").value);
      formData.append("Family", document.getElementById("addFamily").value);
      formData.append("OrderName", document.getElementById("addOrderName").value);
      formData.append("Description", document.getElementById("addDescription").value);

      fetch(`/Admin/Management/SpeciesManagement?handler=Add`, {
        method: 'POST',
        body: formData
      })
        .then(r => r.json())
        .then(data => {
          if (data.success) {
            showToast(data.message, "success");
            addModal.hide();
            reloadSpeciesList();
          } else {
            document.getElementById('addError').innerText = data.message || "Có lỗi xảy ra!";
          }
        })
        .catch(err => console.error("Error adding species:", err));

      return false;
    }

    let deleteSpeciesId = 0;

    function checkBeforeDelete(id) {
      fetch(`/Admin/Management/SpeciesManagement?handler=CheckBeforeDelete`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ id })
      })
        .then(res => res.json())
        .then(data => {
          deleteSpeciesId = id;
          document.getElementById("deleteModalBody").innerHTML = data.message;
          new bootstrap.Modal(document.getElementById("deleteConfirmModal")).show();
        });
    }

    document.getElementById("confirmDeleteBtn").addEventListener("click", () => {
      fetch(`/Admin/Management/SpeciesManagement?handler=DeleteConfirmed&id=${deleteSpeciesId}`, {
        method: 'POST'
      })
        .then(res => res.json())
        .then(data => {
          showToast(data.message, data.success ? "success" : "warning");
          if (data.success) {
            if (@Model.CurrentPage > data.totalPages) {
              reloadSpeciesList(data.totalPages);
            } else {
              reloadSpeciesList();
            }
          }
          bootstrap.Modal.getInstance(document.getElementById("deleteConfirmModal")).hide();
        });
    });

    function reloadSpeciesList(newPage) {
      const pageToLoad = newPage || @Model.CurrentPage;
      const url = `/Admin/Management/SpeciesManagement?handler=List&keyword=${encodeURIComponent("@Model.Keyword")}&currentPage=${pageToLoad}`;

      fetch(url)
        .then(res => res.text())
        .then(html => {
          document.querySelector("table tbody").innerHTML = html;

          fetch(window.location.pathname + `?Keyword=${encodeURIComponent("@Model.Keyword")}&CurrentPage=${pageToLoad}`)
            .then(r => r.text())
            .then(pageHtml => {
              const parser = new DOMParser();
              const newDoc = parser.parseFromString(pageHtml, 'text/html');
              const newPagination = newDoc.querySelector('.pagination-container');

              if (newPagination) {
                document.querySelector('.pagination-container').innerHTML = newPagination.innerHTML;
              }
            });
        })
        .catch(err => console.error("Error reloading species:", err));
    }
  </script>
}