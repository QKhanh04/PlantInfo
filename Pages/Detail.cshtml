@page "{id:int}"
@inject Microsoft.AspNetCore.Antiforgery.IAntiforgery Antiforgery
@using PlantManagement.DTOs

@model DetailModel
@{
    ViewData["Title"] = "Chi tiết cây trồng";
}

@section Styles {
    <link rel="stylesheet" href="~/css/detail.css" />
}

<div class="detail-container">
    <!-- Back Button & Admin Actions -->
    <div class="top-actions-bar" data-aos="fade-down">
        <a class="back-button" href="javascript:history.back()">
            <i class="bi bi-arrow-left me-2"></i> Quay lại
        </a>

        @if (User.IsInRole("Admin"))
        {
            <div class="admin-actions">
                <a asp-page="/Admin/Update" asp-route-id="@Model.Plants.PlantId" class="action-btn btn-edit">
                    <i class="bi bi-pencil-square"></i> Chỉnh sửa
                </a>
            </div>
        }
    </div>

    <!-- Header Section -->
    <div class="plant-header" data-aos="fade-up">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <!-- Rating & Favorite Row -->
                <div class="rating-favorite-row mb-3">
                    <!-- Rating Display -->
                    <div class="rating-display">
                        <div class="stars-large">
                            @{
                                var avg = Model.RatingSummary.AverageRating;
                                int fullStars = (int)avg;
                                bool hasHalfStar = avg - fullStars >= 0.25 && avg - fullStars < 0.75;
                                int emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

                                for (int i = 0; i < fullStars; i++)
                                {
                                    <i class="bi bi-star-fill text-warning"></i>
                                }
                                if (hasHalfStar)
                                {
                                    <i class="bi bi-star-half text-warning"></i>
                                }
                                for (int i = 0; i < emptyStars; i++)
                                {
                                    <i class="bi bi-star text-warning"></i>
                                }
                            }
                        </div>
                        <span class="rating-score">@Model.RatingSummary.AverageRating</span>
                        <span class="rating-count">(@Model.RatingSummary.TotalReviews đánh giá)</span>
                    </div>


                    <!-- Favorite Button -->
                    @if (User.Identity.IsAuthenticated)
                    {
                        <button type="button" class="btn-favorite @(Model.IsFavorited ? "favorited" : "")" id="favoriteBtn"
                            data-plant-id="@Model.Id">
                            <i class="bi @(Model.IsFavorited ? "bi-heart-fill" : "bi-heart")"></i>
                            <span>@(Model.IsFavorited ? "Đã yêu thích" : "Yêu thích")</span>
                        </button>
                        @* <input name="__RequestVerificationToken" type="hidden" value="@Antiforgery.GetTokens(HttpContext).RequestToken" /> *@

                    }
                    else
                    {
                        <a asp-page="/Auth/Authentication" asp-route-returnUrl="@PageContext.HttpContext.Request.Path"
                            class="btn-favorite">
                            <i class="bi bi-heart"></i>
                            <span>Yêu thích</span>
                        </a>
                    }
                </div>

                <div class="category-badges">
                    @foreach (var category in Model.Plants.Categories)
                    {
                        <span class="badge-custom" data-tooltip-content="@category.Description">
                            @category.CategoryName
                        </span>
                    }
                </div>

                <h1 class="plant-title">@Model.Plants.CommonName</h1>
                <div class="scientific-name">@Model.Plants.Species?.ScientificName</div>
                <p class="plant-description">@Model.Plants.Description</p>

                <div class="plant-meta">
                    <div class="meta-item">
                        <i class="bi bi-geo-alt"></i>
                        <span>@Model.Plants.Origin</span>
                    </div>
                    @* <div class="meta-item">
                        <i class="bi bi-eye"></i>
                        <span>@Model.ViewCount lượt xem</span>
                    </div> *@
                </div>
            </div>

            <div class="col-lg-6 mt-4 mt-lg-0">
                @{
                    var imageList = Model.Plants.Images ?? new List<PlantImageDTO>();
                    var mainImage = imageList.FirstOrDefault(img => img.IsPrimary)?.ImageUrl ??
                    imageList.FirstOrDefault()?.ImageUrl;
                }
                <div class="plant-image-gallery">
                    <div class="main-image">
                        <img id="mainPlantImage" src="@mainImage" alt="@Model.Plants.CommonName" />
                        <div class="image-overlay">
                            <button class="zoom-btn" onclick="openImageModal()">
                                <i class="bi bi-zoom-in"></i>
                            </button>
                        </div>
                    </div>

                    <div class="d-flex align-items-center justify-content-center mt-3">
                        <button type="button" class="thumbnail-nav-btn" id="thumbPrev" onclick="showThumbnail(-1)">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <div id="thumbnailList" class="thumbnail-container"></div>
                        <button type="button" class="thumbnail-nav-btn" id="thumbNext" onclick="showThumbnail(1)">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Section - Growth Conditions -->
    <div class="stats-section" data-aos="fade-up" data-aos-delay="100">
        <div class="row g-4">
            <div class="col-lg col-md-6">
                <div class="stat-card">
                    <div class="stat-icon-wrapper sunlight">
                        <i class="bi bi-brightness-high stat-icon" style="color:orange"></i>
                    </div>
                    <div class="stat-title">Ánh sáng</div>
                    <div class="stat-value">@Model.Plants.GrowthCondition?.Sunlight</div>

                </div>
            </div>
            <div class="col-lg col-md-6">
                <div class="stat-card">
                    <div class="stat-icon-wrapper water">
                        <i class="bi bi-droplet stat-icon" style="color:rgb(115, 186, 245)"></i>
                    </div>
                    <div class="stat-title">Tưới nước</div>
                    <div class="stat-value">@Model.Plants.GrowthCondition?.WaterRequirement</div>

                </div>
            </div>
            <div class="col-lg col-md-6">
                <div class="stat-card">
                    <div class="stat-icon-wrapper temp">
                        <i class="bi bi-thermometer-half stat-icon" style="color:red"></i>
                    </div>
                    <div class="stat-title">Nhiệt độ</div>
                    <div class="stat-value">@Model.Plants.GrowthCondition?.TemperatureRange</div>

                </div>
            </div>
            <div class="col-lg col-md-6">
                <div class="stat-card">
                    <div class="stat-icon-wrapper temp">
                        <i class="bi bi-cloud stat-icon" style="color:rgb(133, 223, 250)"></i>
                    </div>
                    <div class="stat-title">Thời tiết</div>
                    <div class="stat-value">@Model.Plants.GrowthCondition?.Climate</div>

                </div>
            </div>
            <div class="col-lg col-md-6">
                <div class="stat-card">
                    <div class="stat-icon-wrapper temp">
                        <i class="bi bi-grid stat-icon" style="color:brown"></i>
                    </div>
                    <div class="stat-title">Loại đất</div>
                    <div class="stat-value">@Model.Plants.GrowthCondition?.SoilType</div>

                </div>
            </div>
        </div>
    </div>

    <!-- Info Sections -->
    <div class="info-section" data-aos="fade-up" data-aos-delay="100">
        <div class="row g-4">
            <!-- Thông tin cơ bản -->
            <div class="col-md-6">
                <div class="info-box">
                    <div class="section-header">
                        <i class="bi bi-info-circle section-icon"></i>
                        <div class="section-title">Thông tin cơ bản</div>
                    </div>
                    <div class="info-content">
                        <div class="kv-row">
                            <div class="kv-key"><i class="bi bi-flower1"></i> Họ thực vật</div>
                            <div class="kv-value">@Model.Plants.Species?.Family</div>
                        </div>
                        <div class="divider"></div>
                        <div class="kv-row">
                            <div class="kv-key"><i class="bi bi-diagram-3"></i> Chi</div>
                            <div class="kv-value">@Model.Plants.Species?.Genus</div>
                        </div>
                        <div class="divider"></div>
                        <div class="kv-row">
                            <div class="kv-key"><i class="bi bi-collection"></i> Bộ</div>
                            <div class="kv-value">@Model.Plants.Species?.OrderName</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Công dụng chính -->
            <div class="col-md-6">
                <div class="info-box">
                    <div class="section-header">
                        <i class="bi bi-heart-pulse section-icon"></i>
                        <div class="section-title">Công dụng chính</div>
                    </div>
                    <div class="badge-list">
                        @foreach (var use in Model.Plants.Uses)
                        {
                            <span class="badge-item use-badge" data-tooltip-content="@use.Description">
                                <i class="bi bi-check-circle"></i>
                                @use.UseName
                            </span>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Bệnh thường gặp - Full width -->
    <div class="info-section" data-aos="fade-up" data-aos-delay="300">
        <div class="info-box">
            <div class="section-header">
                <i class="bi bi-bug section-icon"></i>
                <div class="section-title">Bệnh thường gặp</div>
            </div>
            <div class="disease-list">
                @if (Model.Plants.Diseases != null && Model.Plants.Diseases.Any())
                {
                    @foreach (var disease in Model.Plants.Diseases)
                    {
                        <div class="disease-card">
                            <div class="disease-header">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                <h5>@disease.DiseaseName</h5>
                            </div>
                            <div class="disease-body">
                                <div class="disease-info">
                                    <strong><i class="bi bi-clipboard-pulse"></i> Triệu chứng:</strong>
                                    <p>@disease.Symptoms</p>
                                </div>
                                <div class="disease-info">
                                    <strong><i class="bi bi-prescription2"></i> Cách chữa:</strong>
                                    <p>@disease.Treatment</p>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted">Chưa có thông tin về bệnh.</p>
                }
            </div>
        </div>
    </div>


    <!-- References -->
    <div class="info-section" data-aos="fade-up" data-aos-delay="400">
        <div class="info-box">
            <div class="section-header">
                <i class="bi bi-book section-icon"></i>
                <div class="section-title">Tài liệu tham khảo</div>
            </div>
            @if (Model.Plants.References != null && Model.Plants.References.Any())
            {
                <div class="references-grid">
                    @foreach (var reference in Model.Plants.References)
                    {
                        <div class="reference-card">
                            <div class="reference-icon">
                                <i class="bi bi-journal-text"></i>
                            </div>
                            <div class="reference-content">
                                <h4>@reference.SourceName</h4>
                                @if (!string.IsNullOrEmpty(reference.Author))
                                {
                                    <p class="author">Tác giả: @reference.Author</p>
                                }
                                @if (reference.PublishedYear.HasValue)
                                {
                                    <p class="year">Năm: @reference.PublishedYear</p>
                                }
                                @if (!string.IsNullOrEmpty(reference.Url))
                                {
                                    <a href="@reference.Url" target="_blank" class="reference-link">
                                        Xem chi tiết <i class="bi bi-arrow-right"></i>
                                    </a>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <p class="text-muted">Chưa có tài liệu tham khảo.</p>
            }
        </div>
    </div>

    <!-- Rating & Review Section -->
    <div class="info-section" data-aos="fade-up" data-aos-delay="500">
        <div class="info-box">
            <div class="section-header">
                <i class="bi bi-star section-icon"></i>
                <div class="section-title">Đánh giá & Nhận xét</div>
            </div>

            <!-- Rating Summary -->
            <div class="rating-summary">
                <div class="rating-overview">
                    <div class="rating-score-large">@Model.RatingSummary.AverageRating</div>
                    <div class="rating-stars-large">
                        @{


                            for (int i = 0; i < fullStars; i++)
                            {
                                <i class="bi bi-star-fill text-warning"></i>
                            }
                            if (hasHalfStar)
                            {
                                <i class="bi bi-star-half text-warning"></i>
                            }
                            for (int i = 0; i < emptyStars; i++)
                            {
                                <i class="bi bi-star text-warning"></i>
                            }
                        }
                    </div>
                    <div class="rating-total">@Model.RatingSummary.TotalReviews đánh giá</div>
                </div>
                <div class="rating-breakdown">
                    @{
                        int total = Model.RatingSummary.TotalReviews == 0 ? 1 : Model.RatingSummary.TotalReviews;
                        double percent5 = Model.RatingSummary.FiveStars * 100.0 / total;
                        double percent4 = Model.RatingSummary.FourStars * 100.0 / total;
                        double percent3 = Model.RatingSummary.ThreeStars * 100.0 / total;
                        double percent2 = Model.RatingSummary.TwoStars * 100.0 / total;
                        double percent1 = Model.RatingSummary.OneStar * 100.0 / total;
                    }
                    <div class="rating-bar-item">
                        <span>5 <i class="bi bi-star-fill"></i></span>
                        <div class="bar">
                            <div class="fill" style="width: @percent5%"></div>
                        </div>
                        <span>@Model.RatingSummary.FiveStars</span>
                    </div>
                    <div class="rating-bar-item">
                        <span>4 <i class="bi bi-star-fill"></i></span>
                        <div class="bar">
                            <div class="fill" style="width: @percent4%"></div>
                        </div>
                        <span>@Model.RatingSummary.FourStars</span>
                    </div>
                    <div class="rating-bar-item">
                        <span>3 <i class="bi bi-star-fill"></i></span>
                        <div class="bar">
                            <div class="fill" style="width: @percent3%"></div>
                        </div>
                        <span>@Model.RatingSummary.ThreeStars</span>
                    </div>
                    <div class="rating-bar-item">
                        <span>2 <i class="bi bi-star-fill"></i></span>
                        <div class="bar">
                            <div class="fill" style="width: @percent2%"></div>
                        </div>
                        <span>@Model.RatingSummary.TwoStars</span>
                    </div>
                    <div class="rating-bar-item">
                        <span>1 <i class="bi bi-star-fill"></i></span>
                        <div class="bar">
                            <div class="fill" style="width: @percent1%"></div>
                        </div>
                        <span>@Model.RatingSummary.OneStar</span>
                    </div>
                </div>
            </div>

            @functions {
                public string TimeAgo(DateTime date)
                {
                    var ts = DateTime.Now - date;
                    if (ts.TotalDays >= 7)
                        return $"{(int)(ts.TotalDays / 7)} tuần trước";
                    if (ts.TotalDays >= 1)
                        return $"{(int)ts.TotalDays} ngày trước";
                    if (ts.TotalHours >= 1)
                        return $"{(int)ts.TotalHours} giờ trước";
                    if (ts.TotalMinutes >= 1)
                        return $"{(int)ts.TotalMinutes} phút trước";
                    return "Vừa xong";
                }
            }

            @if (User.Identity.IsAuthenticated)
            {
                <!-- User's Review Section -->
                <div class="user-review-section">
                    <!-- View Mode: Display existing review -->
                    <div id="reviewViewMode" class="review-item my-review-highlight"
                        style="@(Model.UserReview == null ? "display:none;" : "")">
                        @if (Model.UserReview != null)
                        {
                            <div class="my-review-badge">
                                <i class="bi bi-person-check-fill"></i> Đánh giá của bạn
                            </div>
                            <div class="review-header">
                                <div class="user-avatar">
                                    <i class="bi bi-person-circle"></i>
                                </div>
                                <div class="user-info">
                                    <h5>@Model.UserReview.UserName</h5>
                                    <div class="review-meta">
                                        <div class="stars-small" id="userReviewStars">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                if (i <= Model.UserReview.Rating)
                                                {
                                                    <i class="bi bi-star-fill text-warning"></i>
                                                }
                                                else
                                                {
                                                    <i class="bi bi-star text-warning"></i>
                                                }
                                            }
                                        </div>
                                        <span class="review-date">@TimeAgo(Model.UserReview.CreatedAt)</span>
                                    </div>
                                </div>
                            </div>
                            <div class="review-content">
                                <p id="userReviewComment">@Model.UserReview.Comment</p>
                            </div>
                            <div class="review-actions">
                                <button type="button" class="review-action-btn btn-edit-review" onclick="toggleEditMode()">
                                    <i class="bi bi-pencil"></i> Chỉnh sửa
                                </button>
                            </div>
                        }
                    </div>

                    <!-- Edit Mode: Edit existing review -->
                    @if (Model.UserReview != null)
                    {
                        <div id="reviewEditMode" class="review-form-container" style="display: none;">
                            <form id="editReviewForm">
                                <div class="review-form">
                                    <div class="form-header">
                                        <h4>
                                            <i class="bi bi-pencil-square"></i>
                                            Chỉnh sửa đánh giá của bạn
                                        </h4>
                                        <button type="button" class="btn-close-form" onclick="toggleEditMode()" title="Hủy">
                                            <i class="bi bi-x-lg"></i>
                                        </button>
                                    </div>

                                    <div class="form-body">
                                        <div class="rating-input">
                                            <label class="form-label">
                                                <i class="bi bi-star-fill text-warning"></i>
                                                Đánh giá của bạn
                                            </label>
                                            <div class="star-rating" id="editStarRating">
                                                <i class="bi bi-star" data-rating="1"></i>
                                                <i class="bi bi-star" data-rating="2"></i>
                                                <i class="bi bi-star" data-rating="3"></i>
                                                <i class="bi bi-star" data-rating="4"></i>
                                                <i class="bi bi-star" data-rating="5"></i>
                                            </div>
                                            <input type="hidden" asp-for="UpdateReview.Rating" id="edit-rating-value"
                                                value="@Model.UserReview.Rating" />
                                            <span asp-validation-for="UpdateReview.Rating" class="text-danger"></span>
                                        </div>

                                        <div class="comment-input">
                                            <label class="form-label" for="edit-review-comment">
                                                <i class="bi bi-chat-left-text"></i>
                                                Nhận xét của bạn
                                            </label>
                                            <textarea class="form-control" rows="4" asp-for="UpdateReview.Comment"
                                                id="edit-review-comment"
                                                placeholder="Chia sẻ trải nghiệm của bạn về cây này...">@Model.UserReview.Comment</textarea>
                                            <span asp-validation-for="UpdateReview.Comment" class="text-danger"></span>
                                        </div>
                                    </div>

                                    <div class="form-actions">
                                        <button type="button" class="btn btn-secondary" onclick="toggleEditMode()">
                                            <i class="bi bi-x-circle"></i> Hủy
                                        </button>
                                        <button type="submit" class="btn btn-primary">
                                            <i class="bi bi-check-circle"></i> Cập nhật đánh giá
                                        </button>
                                    </div>

                                    <input name="__RequestVerificationToken" type="hidden"
                                        value="@Antiforgery.GetTokens(HttpContext).RequestToken" />
                                </div>
                            </form>
                        </div>
                    }
                    else
                    {
                        <!-- Add New Review Form -->
                        <div class="review-form-container">
                            <form id="addReviewForm">
                                <div class="review-form">
                                    <div class="form-header">
                                        <h4>
                                            <i class="bi bi-pencil-square"></i>
                                            Viết đánh giá của bạn
                                        </h4>
                                        <span class="form-note">
                                            <i class="bi bi-info-circle"></i>
                                            Bạn chỉ có thể đánh giá một lần
                                        </span>
                                    </div>

                                    <div class="form-body">
                                        <div class="rating-input">
                                            <label class="form-label">
                                                <i class="bi bi-star-fill text-warning"></i>
                                                Chọn số sao
                                            </label>
                                            <div class="star-rating" id="addStarRating">
                                                <i class="bi bi-star" data-rating="1"></i>
                                                <i class="bi bi-star" data-rating="2"></i>
                                                <i class="bi bi-star" data-rating="3"></i>
                                                <i class="bi bi-star" data-rating="4"></i>
                                                <i class="bi bi-star" data-rating="5"></i>
                                            </div>
                                            <input type="hidden" asp-for="AddReview.Rating" id="add-rating-value" />
                                            <span asp-validation-for="AddReview.Rating" class="text-danger"></span>
                                        </div>

                                        <div class="comment-input">
                                            <label class="form-label" for="add-review-comment">
                                                <i class="bi bi-chat-left-text"></i>
                                                Nhận xét của bạn
                                            </label>
                                            <textarea class="form-control" rows="4" asp-for="AddReview.Comment"
                                                id="add-review-comment"
                                                placeholder="Chia sẻ trải nghiệm của bạn về cây này..."></textarea>
                                            <span asp-validation-for="AddReview.Comment" class="text-danger"></span>
                                        </div>
                                    </div>

                                    <div class="form-actions">
                                        <button type="submit" class="btn btn-primary btn-submit-review">
                                            <i class="bi bi-send"></i> Gửi đánh giá
                                        </button>
                                    </div>

                                    <input name="__RequestVerificationToken" type="hidden"
                                        value="@Antiforgery.GetTokens(HttpContext).RequestToken" />
                                </div>
                            </form>
                        </div>
                    }
                </div>
            }
            else
            {
                <!-- Login Prompt -->
                <div class="login-prompt">
                    <div class="login-prompt-icon">
                        <i class="bi bi-lock"></i>
                    </div>
                    <div class="login-prompt-content">
                        <h5>Đăng nhập để đánh giá</h5>
                        <p>Vui lòng <a asp-page="/Auth/Authentication"
                                asp-route-returnUrl="@PageContext.HttpContext.Request.Path">
                                Đăng nhập
                            </a> để viết đánh giá về cây này</p>

                    </div>
                </div>
            }

            <!-- Reviews List -->
            <div class="reviews-list">
                <div class="reviews-list-header">
                    <h4 class="reviews-list-title">
                        Tất cả đánh giá
                        <span class="review-count-badge">@Model.RatingSummary.TotalReviews</span>
                    </h4>
                </div>

                @if (Model.Reviews != null && Model.Reviews.Count > 0)
                {
                    @foreach (var review in Model.Reviews)
                    {
                        <div class="review-item @(review.UserId == Model.CurrentUserId ? "my-review-item" : "")"
                            data-review-id="@review.ReviewId" data-review-user-id="@review.UserId">
                            <div class="review-header">
                                <div class="user-avatar">
                                    <i class="bi bi-person-circle"></i>
                                </div>
                                <div class="user-info">
                                    <h5>@(review.UserName ?? "Ẩn danh")</h5>
                                    <div class="review-meta">
                                        <div class="stars-small">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                if (i <= review.Rating)
                                                {
                                                    <i class="bi bi-star-fill text-warning"></i>
                                                }
                                                else
                                                {
                                                    <i class="bi bi-star text-warning"></i>
                                                }
                                            }
                                        </div>
                                        <span class="review-date">@TimeAgo(review.CreatedAt)</span>
                                    </div>
                                </div>
                            </div>
                            <div class="review-content">
                                <p>@review.Comment</p>
                            </div>
                        </div>
                    }

                    @if (Model.Reviews.Count > 5)
                    {
                        <button class="btn-load-more">
                            <i class="bi bi-arrow-down-circle"></i> Xem thêm đánh giá
                        </button>
                    }
                }
                else
                {
                    <div class="no-reviews-message">
                        <i class="bi bi-chat-left-text"></i>
                        <p>Chưa có đánh giá nào. Hãy là người đầu tiên đánh giá!</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="image-modal">
    <span class="close-modal">&times;</span>
    <img class="modal-content" id="modalImage">
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script src="https://unpkg.com/@@popperjs/core@2"></script>

    <script>
        // Thumbnail carousel logic
        const imageList = [
                                    @foreach (var img in Model.Plants.Images ?? new List<PlantImageDTO>())
            {
                <text>
                    {
                        url: "@img.ImageUrl",
                    isPrimary: @img.IsPrimary.ToString().ToLower()
                                                                                                                                                                                            },
                </text>
                                }
                                ];
    </script>
    <script src="~/js/detail.js"></script>
}