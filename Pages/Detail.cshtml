@page "{id:int}"
@using PlantManagement.DTOs

@model DetailModel
@{
    ViewData["Title"] = "Chi tiết cây trồng";
}

@section Styles {
    <link rel="stylesheet" href="~/css/detail.css" />
}

<div class="detail-container">
    <!-- Back Button & Admin Actions -->
    <div class="top-actions-bar" data-aos="fade-down">
        <a class="back-button" href="javascript:history.back()">
            <i class="bi bi-arrow-left me-2"></i> Quay lại
        </a>

        @if (User.IsInRole("Admin"))
        {
            <div class="admin-actions">
                <a asp-page="/Admin/Update" asp-route-id="@Model.Plants.PlantId" class="action-btn btn-edit">
                    <i class="bi bi-pencil-square"></i> Chỉnh sửa
                </a>
            </div>
        }
    </div>

    <!-- Header Section -->
    <div class="plant-header" data-aos="fade-up">
        <div class="row align-items-center">
            <div class="col-lg-6">
                <!-- Rating & Favorite Row -->
                <div class="rating-favorite-row mb-3">
                    <!-- Rating Display -->
                    <div class="rating-display">
                        <div class="stars-large">
                            @{
                                var avg = Model.RatingSummary.AverageRating;
                                int fullStars = (int)avg;
                                bool hasHalfStar = avg - fullStars >= 0.25 && avg - fullStars < 0.75;
                                int emptyStars = 5 - fullStars - (hasHalfStar ? 1 : 0);

                                for (int i = 0; i < fullStars; i++)
                                {
                                    <i class="bi bi-star-fill text-warning"></i>
                                }
                                if (hasHalfStar)
                                {
                                    <i class="bi bi-star-half text-warning"></i>
                                }
                                for (int i = 0; i < emptyStars; i++)
                                {
                                    <i class="bi bi-star text-warning"></i>
                                }
                            }
                        </div>
                        <span class="rating-score">@Model.RatingSummary.AverageRating</span>
                        <span class="rating-count">(@Model.RatingSummary.TotalReviews đánh giá)</span>
                    </div>

                    <!-- Favorite Button -->
                    @if (User.Identity.IsAuthenticated)
                    {
                        <form method="post" asp-page-handler="ToggleFavorite" id="favoriteForm">
                            <button type="submit" class="btn-favorite @(Model.IsFavorited ? "favorited" : "")"
                                id="favoriteBtn">
                                <i class="bi @(Model.IsFavorited ? "bi-heart-fill" : "bi-heart")"></i>
                                <span>@(Model.IsFavorited ? "Đã yêu thích" : "Yêu thích")</span>
                            </button>
                        </form>
                    }
                    else
                    {
                        <a asp-page="/Auth/Authentication" asp-route-returnUrl="@PageContext.HttpContext.Request.Path"
                            class="btn-favorite">
                            <i class="bi bi-heart"></i>
                            <span>Yêu thích</span>
                        </a>
                    }
                </div>

                <div class="category-badges">
                    @foreach (var category in Model.Plants.Categories)
                    {
                        <span class="badge-custom" data-tooltip-content="@category.Description">
                            @category.CategoryName
                        </span>
                    }
                </div>

                <h1 class="plant-title">@Model.Plants.CommonName</h1>
                <div class="scientific-name">@Model.Plants.Species?.ScientificName</div>
                <p class="plant-description">@Model.Plants.Description</p>

                <div class="plant-meta">
                    <div class="meta-item">
                        <i class="bi bi-geo-alt"></i>
                        <span>@Model.Plants.Origin</span>
                    </div>
                    @* <div class="meta-item">
                        <i class="bi bi-eye"></i>
                        <span>@Model.ViewCount lượt xem</span>
                    </div> *@
                </div>
            </div>

            <div class="col-lg-6 mt-4 mt-lg-0">
                @{
                    var imageList = Model.Plants.Images ?? new List<PlantImageDTO>();
                    var mainImage = imageList.FirstOrDefault(img => img.IsPrimary)?.ImageUrl ??
                    imageList.FirstOrDefault()?.ImageUrl;
                }
                <div class="plant-image-gallery">
                    <div class="main-image">
                        <img id="mainPlantImage" src="@mainImage" alt="@Model.Plants.CommonName" />
                        <div class="image-overlay">
                            <button class="zoom-btn" onclick="openImageModal()">
                                <i class="bi bi-zoom-in"></i>
                            </button>
                        </div>
                    </div>

                    <div class="d-flex align-items-center justify-content-center mt-3">
                        <button type="button" class="thumbnail-nav-btn" id="thumbPrev" onclick="showThumbnail(-1)">
                            <i class="bi bi-chevron-left"></i>
                        </button>
                        <div id="thumbnailList" class="thumbnail-container"></div>
                        <button type="button" class="thumbnail-nav-btn" id="thumbNext" onclick="showThumbnail(1)">
                            <i class="bi bi-chevron-right"></i>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Stats Section - Growth Conditions -->
    <div class="stats-section" data-aos="fade-up" data-aos-delay="100">
        <div class="row g-4">
            <div class="col-lg col-md-6">
                <div class="stat-card">
                    <div class="stat-icon-wrapper sunlight">
                        <i class="bi bi-brightness-high stat-icon" style="color:orange"></i>
                    </div>
                    <div class="stat-title">Ánh sáng</div>
                    <div class="stat-value">@Model.Plants.GrowthCondition?.Sunlight</div>
                  
                </div>
            </div>
            <div class="col-lg col-md-6">
                <div class="stat-card">
                    <div class="stat-icon-wrapper water">
                        <i class="bi bi-droplet stat-icon" style="color:rgb(115, 186, 245)"></i>
                    </div>
                    <div class="stat-title">Tưới nước</div>
                    <div class="stat-value">@Model.Plants.GrowthCondition?.WaterRequirement</div>
                  
                </div>
            </div>
            <div class="col-lg col-md-6">
                <div class="stat-card">
                    <div class="stat-icon-wrapper temp">
                        <i class="bi bi-thermometer-half stat-icon" style="color:red"></i>
                    </div>
                    <div class="stat-title">Nhiệt độ</div>
                    <div class="stat-value">@Model.Plants.GrowthCondition?.TemperatureRange</div>
                   
                </div>
            </div>
             <div class="col-lg col-md-6">
                <div class="stat-card">
                    <div class="stat-icon-wrapper temp">
                        <i class="bi bi-cloud stat-icon" style="color:rgb(133, 223, 250)"></i>
                    </div>
                    <div class="stat-title">Thời tiết</div>
                    <div class="stat-value">@Model.Plants.GrowthCondition?.Climate</div>
                 
                </div>
            </div>
             <div class="col-lg col-md-6">
                <div class="stat-card">
                    <div class="stat-icon-wrapper temp">
                        <i class="bi bi-grid stat-icon" style="color:brown"></i>
                    </div>
                    <div class="stat-title">Loại đất</div>
                    <div class="stat-value">@Model.Plants.GrowthCondition?.SoilType</div>
                
                </div>
            </div>
        </div>
    </div>

    <!-- Info Sections -->
    <div class="info-section" data-aos="fade-up" data-aos-delay="100">
        <div class="row g-4">
            <!-- Thông tin cơ bản -->
            <div class="col-md-6">
                <div class="info-box">
                    <div class="section-header">
                        <i class="bi bi-info-circle section-icon"></i>
                        <div class="section-title">Thông tin cơ bản</div>
                    </div>
                    <div class="info-content">
                        <div class="kv-row">
                            <div class="kv-key"><i class="bi bi-flower1"></i> Họ thực vật</div>
                            <div class="kv-value">@Model.Plants.Species?.Family</div>
                        </div>
                        <div class="divider"></div>
                        <div class="kv-row">
                            <div class="kv-key"><i class="bi bi-diagram-3"></i> Chi</div>
                            <div class="kv-value">@Model.Plants.Species?.Genus</div>
                        </div>
                        <div class="divider"></div>
                        <div class="kv-row">
                            <div class="kv-key"><i class="bi bi-collection"></i> Bộ</div>
                            <div class="kv-value">@Model.Plants.Species?.OrderName</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Công dụng chính -->
            <div class="col-md-6">
                <div class="info-box">
                    <div class="section-header">
                        <i class="bi bi-heart-pulse section-icon"></i>
                        <div class="section-title">Công dụng chính</div>
                    </div>
                    <div class="badge-list">
                        @foreach (var use in Model.Plants.Uses)
                        {
                            <span class="badge-item use-badge" data-tooltip-content="@use.Description">
                                <i class="bi bi-check-circle"></i>
                                @use.UseName
                            </span>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Điều kiện sinh trưởng - 2 cột -->
    @* <div class="info-section" data-aos="fade-up" data-aos-delay="200">
        <div class="row g-4">
            <div class="col-md-6">
                <div class="info-box">
                    <div class="section-header">
                        <i class="bi bi-cloud-sun section-icon"></i>
                        <div class="section-title">Điều kiện sinh trưởng</div>
                    </div>
                    <div class="info-content">
                        <div class="kv-row">
                            <div class="kv-key"><i class="bi bi-brightness-high"></i> Ánh sáng</div>
                            <div class="kv-value">@Model.Plants.GrowthCondition?.Sunlight</div>
                        </div>
                        <div class="divider"></div>
                        <div class="kv-row">
                            <div class="kv-key"><i class="bi bi-droplet"></i> Tưới nước</div>
                            <div class="kv-value">@Model.Plants.GrowthCondition?.WaterRequirement</div>
                        </div>
                        <div class="divider"></div>
                        <div class="kv-row">
                            <div class="kv-key"><i class="bi bi-thermometer-half"></i> Nhiệt độ</div>
                            <div class="kv-value">@Model.Plants.GrowthCondition?.TemperatureRange</div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="col-md-6">
                <div class="info-box">
                    <div class="section-header">
                        <i class="bi bi-layers section-icon"></i>
                        <div class="section-title">Đất & Khí hậu</div>
                    </div>
                    <div class="info-content">
                        <div class="kv-row">
                            <div class="kv-key"><i class="bi bi-grid-3x3-gap"></i> Loại đất</div>
                            <div class="kv-value">@Model.Plants.GrowthCondition?.SoilType</div>
                        </div>
                        <div class="divider"></div>
                        <div class="kv-row">
                            <div class="kv-key"><i class="bi bi-cloud-sun"></i> Khí hậu</div>
                            <div class="kv-value">@Model.Plants.GrowthCondition?.Climate</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div> *@

    <!-- Bệnh thường gặp - Full width -->
    <div class="info-section" data-aos="fade-up" data-aos-delay="300">
        <div class="info-box">
            <div class="section-header">
                <i class="bi bi-bug section-icon"></i>
                <div class="section-title">Bệnh thường gặp</div>
            </div>
            <div class="disease-list">
                @if (Model.Plants.Diseases != null && Model.Plants.Diseases.Any())
                {
                    @foreach (var disease in Model.Plants.Diseases)
                    {
                        <div class="disease-card">
                            <div class="disease-header">
                                <i class="bi bi-exclamation-triangle-fill"></i>
                                <h5>@disease.DiseaseName</h5>
                            </div>
                            <div class="disease-body">
                                <div class="disease-info">
                                    <strong><i class="bi bi-clipboard-pulse"></i> Triệu chứng:</strong>
                                    <p>@disease.Symptoms</p>
                                </div>
                                <div class="disease-info">
                                    <strong><i class="bi bi-prescription2"></i> Cách chữa:</strong>
                                    <p>@disease.Treatment</p>
                                </div>
                            </div>
                        </div>
                    }
                }
                else
                {
                    <p class="text-muted">Chưa có thông tin về bệnh.</p>
                }
            </div>
        </div>
    </div>


    <!-- References -->
    <div class="info-section" data-aos="fade-up" data-aos-delay="400">
        <div class="info-box">
            <div class="section-header">
                <i class="bi bi-book section-icon"></i>
                <div class="section-title">Tài liệu tham khảo</div>
            </div>
            @if (Model.Plants.References != null && Model.Plants.References.Any())
            {
                <div class="references-grid">
                    @foreach (var reference in Model.Plants.References)
                    {
                        <div class="reference-card">
                            <div class="reference-icon">
                                <i class="bi bi-journal-text"></i>
                            </div>
                            <div class="reference-content">
                                <h4>@reference.SourceName</h4>
                                @if (!string.IsNullOrEmpty(reference.Author))
                                {
                                    <p class="author">Tác giả: @reference.Author</p>
                                }
                                @if (reference.PublishedYear.HasValue)
                                {
                                    <p class="year">Năm: @reference.PublishedYear</p>
                                }
                                @if (!string.IsNullOrEmpty(reference.Url))
                                {
                                    <a href="@reference.Url" target="_blank" class="reference-link">
                                        Xem chi tiết <i class="bi bi-arrow-right"></i>
                                    </a>
                                }
                            </div>
                        </div>
                    }
                </div>
            }
            else
            {
                <p class="text-muted">Chưa có tài liệu tham khảo.</p>
            }
        </div>
    </div>

    <!-- Rating & Review Section -->
    <div class="info-section" data-aos="fade-up" data-aos-delay="500">
        <div class="info-box">
            <div class="section-header">
                <i class="bi bi-star section-icon"></i>
                <div class="section-title">Đánh giá & Nhận xét</div>
            </div>

            <!-- Rating Summary -->
            <div class="rating-summary">
                <div class="rating-overview">
                    <div class="rating-score-large">@Model.RatingSummary.AverageRating</div>
                    <div class="rating-stars-large">
                        @{
                            for (int i = 0; i < fullStars; i++)
                            {
                                <i class="bi bi-star-fill text-warning"></i>
                            }
                            if (hasHalfStar)
                            {
                                <i class="bi bi-star-half text-warning"></i>
                            }
                            for (int i = 0; i < emptyStars; i++)
                            {
                                <i class="bi bi-star text-warning"></i>
                            }
                        }
                    </div>
                    <div class="rating-total">@Model.RatingSummary.TotalReviews đánh giá</div>
                </div>
                <div class="rating-breakdown">
                    @{
                        int total = Model.RatingSummary.TotalReviews == 0 ? 1 : Model.RatingSummary.TotalReviews;
                        double percent5 = Model.RatingSummary.FiveStars * 100.0 / total;
                        double percent4 = Model.RatingSummary.FourStars * 100.0 / total;
                        double percent3 = Model.RatingSummary.ThreeStars * 100.0 / total;
                        double percent2 = Model.RatingSummary.TwoStars * 100.0 / total;
                        double percent1 = Model.RatingSummary.OneStar * 100.0 / total;
                    }
                    <div class="rating-bar-item">
                        <span>5 <i class="bi bi-star-fill"></i></span>
                        <div class="bar">
                            <div class="fill" style="width: @percent5%"></div>
                        </div>
                        <span>@Model.RatingSummary.FiveStars</span>
                    </div>
                    <div class="rating-bar-item">
                        <span>4 <i class="bi bi-star-fill"></i></span>
                        <div class="bar">
                            <div class="fill" style="width: @percent4%"></div>
                        </div>
                        <span>@Model.RatingSummary.FourStars</span>
                    </div>
                    <div class="rating-bar-item">
                        <span>3 <i class="bi bi-star-fill"></i></span>
                        <div class="bar">
                            <div class="fill" style="width: @percent3%"></div>
                        </div>
                        <span>@Model.RatingSummary.ThreeStars</span>
                    </div>
                    <div class="rating-bar-item">
                        <span>2 <i class="bi bi-star-fill"></i></span>
                        <div class="bar">
                            <div class="fill" style="width: @percent2%"></div>
                        </div>
                        <span>@Model.RatingSummary.TwoStars</span>
                    </div>
                    <div class="rating-bar-item">
                        <span>1 <i class="bi bi-star-fill"></i></span>
                        <div class="bar">
                            <div class="fill" style="width: @percent1%"></div>
                        </div>
                        <span>@Model.RatingSummary.OneStar</span>
                    </div>
                </div>
            </div>

            @functions {
                public string TimeAgo(DateTime date)
                {
                    var ts = DateTime.Now - date;
                    if (ts.TotalDays >= 7)
                        return $"{(int)(ts.TotalDays / 7)} tuần trước";
                    if (ts.TotalDays >= 1)
                        return $"{(int)ts.TotalDays} ngày trước";
                    if (ts.TotalHours >= 1)
                        return $"{(int)ts.TotalHours} giờ trước";
                    if (ts.TotalMinutes >= 1)
                        return $"{(int)ts.TotalMinutes} phút trước";
                    return "Vừa xong";
                }
            }

            @if (User.Identity.IsAuthenticated)
            {
                @if (Model.UserReview != null)
                {
                    <!-- Hiển thị đánh giá hiện tại của người dùng -->
                    <div class="user-existing-review">
                        <div class="alert alert-info">
                            <i class="bi bi-check-circle-fill me-2"></i>
                            <strong>Bạn đã đánh giá cây này!</strong>
                            <span class="ms-2">Bạn có thể chỉnh sửa đánh giá của mình.</span>
                        </div>

                        <!-- View Mode -->
                        <div id="reviewViewMode" class="review-item my-review-highlight">
                            <div class="my-review-badge">
                                <i class="bi bi-person-check-fill"></i> Đánh giá của bạn
                            </div>
                            <div class="review-header">
                                <div class="user-avatar">
                                    <i class="bi bi-person-circle"></i>
                                </div>
                                <div class="user-info">
                                    <h5>@Model.UserReview.UserName</h5>
                                    <div class="review-meta">
                                        <div class="stars-small" id="userReviewStars">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                if (i <= Model.UserReview.Rating)
                                                {
                                                    <i class="bi bi-star-fill text-warning"></i>
                                                }
                                                else
                                                {
                                                    <i class="bi bi-star text-warning"></i>
                                                }
                                            }
                                        </div>
                                        <span class="review-date">@TimeAgo(Model.UserReview.CreatedAt)</span>
                                    </div>
                                </div>
                            </div>
                            <div class="review-content">
                                <p id="userReviewComment">@Model.UserReview.Comment</p>
                            </div>
                            <div class="review-actions">
                                <button type="button" class="review-action-btn btn-edit-review" onclick="toggleEditMode()">
                                    <i class="bi bi-pencil"></i> Chỉnh sửa
                                </button>
                            </div>
                        </div>

                        <!-- Edit Mode -->
                        <div id="reviewEditMode" style="display: none;">
                            <form method="post" asp-page-handler="UpdateReview">
                                <div class="review-form">
                                    <div class="form-header-info">
                                        <h4>Chỉnh sửa đánh giá của bạn</h4>
                                        <button type="button" class="btn-cancel-edit" onclick="toggleEditMode()">
                                            <i class="bi bi-x-circle"></i> Hủy
                                        </button>
                                    </div>
                                    <div class="rating-input">
                                        <label>Chọn số sao:</label>
                                        <div class="star-rating" id="editStarRating">
                                            <i class="bi bi-star" data-rating="1"></i>
                                            <i class="bi bi-star" data-rating="2"></i>
                                            <i class="bi bi-star" data-rating="3"></i>
                                            <i class="bi bi-star" data-rating="4"></i>
                                            <i class="bi bi-star" data-rating="5"></i>
                                        </div>
                                        <input type="hidden" asp-for="UpdateReview.Rating" id="edit-rating-value"
                                            value="@Model.UserReview.Rating" required />
                                        <span asp-validation-for="UpdateReview.Rating" class="text-danger"></span>
                                    </div>
                                    <textarea class="form-control" rows="4" asp-for="UpdateReview.Comment"
                                        placeholder="Chia sẻ trải nghiệm của bạn về cây này..."
                                        required>@Model.UserReview.Comment</textarea>
                                    <span asp-validation-for="UpdateReview.Comment" class="text-danger"></span>
                                    <div class="form-actions">
                                        <button type="submit" class="btn-submit-review">
                                            <i class="bi bi-check-circle"></i> Cập nhật đánh giá
                                        </button>
                                        <button type="button" class="btn-cancel" onclick="toggleEditMode()">
                                            <i class="bi bi-x-circle"></i> Hủy
                                        </button>
                                    </div>
                                </div>
                            </form>
                        </div>
                    </div>
                }
                else
                {
                    <!-- Form đánh giá cho người chưa đánh giá -->
                    <form method="post" asp-page-handler="AddReview">
                        <div class="review-form">
                            <div class="form-header-info">
                                <h4>Viết đánh giá của bạn</h4>
                                <span class="text-muted">
                                    <i class="bi bi-info-circle"></i> Bạn chỉ có thể đánh giá một lần
                                </span>
                            </div>
                            <div class="rating-input">
                                <label>Chọn số sao:</label>
                                <div class="star-rating" id="addStarRating">
                                    <i class="bi bi-star" data-rating="1"></i>
                                    <i class="bi bi-star" data-rating="2"></i>
                                    <i class="bi bi-star" data-rating="3"></i>
                                    <i class="bi bi-star" data-rating="4"></i>
                                    <i class="bi bi-star" data-rating="5"></i>
                                </div>
                                <input type="hidden" asp-for="NewReview.Rating" id="add-rating-value" required />
                                <span asp-validation-for="NewReview.Rating" class="text-danger"></span>
                            </div>
                            <textarea class="form-control" rows="4" asp-for="NewReview.Comment"
                                placeholder="Chia sẻ trải nghiệm của bạn về cây này..." required></textarea>
                            <span asp-validation-for="NewReview.Comment" class="text-danger"></span>
                            <button type="submit" class="btn-submit-review">
                                <i class="bi bi-send"></i> Gửi đánh giá
                            </button>
                        </div>
                    </form>
                }
            }
            else
            {
                <div class="login-prompt">
                    <i class="bi bi-lock"></i>
                    <p>Vui lòng <a asp-page="/Auth/Authentication"
                            asp-route-returnUrl="@PageContext.HttpContext.Request.Path">
                            Đăng nhập
                        </a> để viết đánh giá</p>
                </div>
            }

            <!-- Reviews List -->
            <div class="reviews-list">
                <h4 class="reviews-list-title">Tất cả đánh giá (@Model.RatingSummary.TotalReviews)</h4>

                @if (Model.Reviews != null && Model.Reviews.Count > 0)
                {
                    @foreach (var review in Model.Reviews)
                    {
                        <div class="review-item">
                            <div class="review-header">
                                <div class="user-avatar">
                                    <i class="bi bi-person-circle"></i>
                                </div>
                                <div class="user-info">
                                    <h5>@(review.UserName ?? "Ẩn danh")</h5>
                                    <div class="review-meta">
                                        <div class="stars-small">
                                            @for (int i = 1; i <= 5; i++)
                                            {
                                                if (i <= review.Rating)
                                                {
                                                    <i class="bi bi-star-fill text-warning"></i>
                                                }
                                                else
                                                {
                                                    <i class="bi bi-star text-warning"></i>
                                                }
                                            }
                                        </div>
                                        <span class="review-date">@TimeAgo(review.CreatedAt)</span>
                                    </div>
                                </div>
                            </div>
                            <div class="review-content">
                                <p>@review.Comment</p>
                            </div>
                        </div>
                    }

                    @if (Model.Reviews.Count > 5)
                    {
                        <button class="btn-load-more">
                            <i class="bi bi-arrow-down-circle"></i> Xem thêm đánh giá
                        </button>
                    }
                }
                else
                {
                    <div class="no-reviews-message">
                        <i class="bi bi-chat-left-text"></i>
                        <p>Chưa có đánh giá nào. Hãy là người đầu tiên đánh giá!</p>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Image Modal -->
<div id="imageModal" class="image-modal">
    <span class="close-modal">&times;</span>
    <img class="modal-content" id="modalImage">
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/aos/2.3.4/aos.js"></script>
    <script src="https://unpkg.com/@@popperjs/core@2"></script>

    <script>
        AOS.init({
            duration: 800,
            easing: 'ease-out-cubic',
            once: true
        });

        // Thumbnail carousel logic
        const imageList = [
                        @foreach (var img in Model.Plants.Images ?? new List<PlantImageDTO>())
            {
                <text>
                    {
                        url: "@img.ImageUrl",
                    isPrimary: @img.IsPrimary.ToString().ToLower()
                                            },
                </text>
                                    }
                                    ];

        let thumbStart = 0;
        const thumbPerPage = 5;

        function renderThumbnails() {
            const container = document.getElementById('thumbnailList');
            container.innerHTML = '';
            for (let i = thumbStart; i < Math.min(imageList.length, thumbStart + thumbPerPage); i++) {
                const img = imageList[i];
                const el = document.createElement('img');
                el.src = img.url;
                el.className = 'thumbnail-img' + (img.isPrimary ? ' active' : '');
                el.onclick = function () {
                    document.getElementById('mainPlantImage').src = img.url;
                    document.querySelectorAll('.thumbnail-img').forEach(t => t.classList.remove('active'));
                    el.classList.add('active');
                };
                container.appendChild(el);
            }
            document.getElementById('thumbPrev').disabled = (thumbStart === 0);
            document.getElementById('thumbNext').disabled = (thumbStart + thumbPerPage >= imageList.length);
        }

        function showThumbnail(direction) {
            thumbStart += direction;
            if (thumbStart < 0) thumbStart = 0;
            if (thumbStart > imageList.length - thumbPerPage) thumbStart = imageList.length - thumbPerPage;
            renderThumbnails();
        }

        // Image Modal
        function openImageModal() {
            const modal = document.getElementById('imageModal');
            const modalImg = document.getElementById('modalImage');
            const mainImg = document.getElementById('mainPlantImage');
            modal.style.display = "block";
            modalImg.src = mainImg.src;
        }

        document.querySelector('.close-modal')?.addEventListener('click', function () {
            document.getElementById('imageModal').style.display = "none";
        });

        // Toggle Edit Mode
        function toggleEditMode() {
            const viewMode = document.getElementById('reviewViewMode');
            const editMode = document.getElementById('reviewEditMode');

            if (viewMode.style.display === 'none') {
                viewMode.style.display = 'block';
                editMode.style.display = 'none';
            } else {
                viewMode.style.display = 'none';
                editMode.style.display = 'block';
                const currentRating = parseInt(document.getElementById('edit-rating-value').value);
                updateEditStars(currentRating);
            }
        }

        // Star rating for Add Review
        document.addEventListener('DOMContentLoaded', function () {
            renderThumbnails();

            const addStarRating = document.getElementById('addStarRating');
            if (addStarRating) {
                initializeStarRating(addStarRating, 'add-rating-value');
            }

            const editStarRating = document.getElementById('editStarRating');
            if (editStarRating) {
                initializeStarRating(editStarRating, 'edit-rating-value');
                const currentRating = parseInt(document.getElementById('edit-rating-value').value);
                updateStarsDisplay(editStarRating, currentRating);
            }

            // Tooltip functionality
            const badgeItems = document.querySelectorAll('.badge-custom');
            let tooltipEl = null;
            let popperInstance = null;

            badgeItems.forEach(badge => {
                badge.addEventListener('mouseenter', function () {
                    tooltipEl = document.createElement('div');
                    tooltipEl.className = 'custom-tooltip';
                    tooltipEl.innerHTML = badge.getAttribute('data-tooltip-content');
                    document.body.appendChild(tooltipEl);

                    popperInstance = Popper.createPopper(badge, tooltipEl, {
                        placement: 'top',
                        modifiers: [{ name: 'offset', options: { offset: [0, 8] } }]
                    });
                });

                badge.addEventListener('mouseleave', function () {
                    if (tooltipEl) {
                        document.body.removeChild(tooltipEl);
                        tooltipEl = null;
                    }
                    if (popperInstance) {
                        popperInstance.destroy();
                        popperInstance = null;
                    }
                });
            });
        });

        function initializeStarRating(container, inputId) {
            const stars = container.querySelectorAll('i');
            let selectedRating = parseInt(document.getElementById(inputId).value) || 0;

            stars.forEach(star => {
                star.addEventListener('click', function () {
                    selectedRating = parseInt(this.getAttribute('data-rating'));
                    updateStarsDisplay(container, selectedRating);
                    document.getElementById(inputId).value = selectedRating;
                });

                star.addEventListener('mouseenter', function () {
                    const rating = parseInt(this.getAttribute('data-rating'));
                    updateStarsDisplay(container, rating);
                });
            });

            container.addEventListener('mouseleave', function () {
                updateStarsDisplay(container, selectedRating);
            });

            if (selectedRating > 0) {
                updateStarsDisplay(container, selectedRating);
            }
        }

        function updateStarsDisplay(container, rating) {
            const stars = container.querySelectorAll('i');
            stars.forEach(star => {
                const starRating = parseInt(star.getAttribute('data-rating'));
                if (starRating <= rating) {
                    star.classList.remove('bi-star');
                    star.classList.add('bi-star-fill');
                } else {
                    star.classList.remove('bi-star-fill');
                    star.classList.add('bi-star');
                }
            });
        }

        function updateEditStars(rating) {
            const editStarRating = document.getElementById('editStarRating');
            if (editStarRating) {
                updateStarsDisplay(editStarRating, rating);
            }
        }
    </script>
}